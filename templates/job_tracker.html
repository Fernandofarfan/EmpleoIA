<!-- templates/job_tracker.html -->
{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tracker_premium.css') }}">

<div class="container-fluid px-4 mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold text-dark mb-1">Tablero de Postulaciones</h2>
      <p class="text-muted mb-0">Gestiona el estado de tus aplicaciones en tiempo real</p>
    </div>
    <div class="d-flex gap-2">
      <a href="/results" class="btn btn-outline-success">
        <i class="bi bi-file-earmark-spreadsheet me-2"></i> Importar de Resultados
      </a>
      <button class="btn btn-outline-secondary" id="toggleCompactView" onclick="toggleCompactView()">
        <i class="bi bi-list-ul me-2"></i> Vista Compacta
      </button>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addJobModal">
        <i class="bi bi-plus-lg me-2"></i> Agregar Manualmente
      </button>
    </div>
  </div>

  <!-- Stage Pipeline -->
  <div class="pipeline-container">
    <div class="row g-4 flex-nowrap pb-4" style="overflow-x: auto;">

      <!-- Applied -->
      <div class="col-md-3" style="min-width: 280px;">
        <div class="stage-column stage-applied" data-stage="applied">
          <div class="stage-header">
            <span><i class="bi bi-send me-2"></i> Enviados</span>
            <span class="badge bg-white text-primary shadow-sm" id="count-applied">0</span>
          </div>
          <div class="stage-body" id="stage-applied">
            <!-- Jobs will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Interviewing -->
      <div class="col-md-3" style="min-width: 280px;">
        <div class="stage-column stage-interviewing" data-stage="interviewing">
          <div class="stage-header">
            <span><i class="bi bi-camera-video me-2"></i> Entrevista</span>
            <span class="badge bg-white text-warning shadow-sm" id="count-interviewing">0</span>
          </div>
          <div class="stage-body" id="stage-interviewing">
            <!-- Jobs will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Negotiating -->
      <div class="col-md-3" style="min-width: 280px;">
        <div class="stage-column stage-negotiating" data-stage="negotiating">
          <div class="stage-header">
            <span><i class="bi bi-currency-dollar me-2"></i> Negociando</span>
            <span class="badge bg-white text-danger shadow-sm" id="count-negotiating">0</span>
          </div>
          <div class="stage-body" id="stage-negotiating">
            <!-- Jobs will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Accepted -->
      <div class="col-md-3" style="min-width: 280px;">
        <div class="stage-column stage-accepted" data-stage="accepted">
          <div class="stage-header">
            <span><i class="bi bi-trophy me-2"></i> Aceptado</span>
            <span class="badge bg-white text-success shadow-sm" id="count-accepted">0</span>
          </div>
          <div class="stage-body" id="stage-accepted">
            <!-- Jobs will be loaded here -->
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Add Manual Job Modal -->
<div class="modal fade" id="addJobModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-light border-bottom-0">
        <h5 class="modal-title fw-bold">Agregar Empleo Manualmente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form id="addJobForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small fw-bold text-muted">Puesto *</label>
              <input type="text" class="form-control" name="title" required placeholder="ej. Senior Python Dev">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold text-muted">Empresa *</label>
              <input type="text" class="form-control" name="company" required placeholder="ej. Tech Corp">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold text-muted">Ubicación</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0"><i class="bi bi-geo-alt"></i></span>
                <input type="text" class="form-control border-start-0" name="location" placeholder="Ciudad, País">
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold text-muted">Salario</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0"><i class="bi bi-currency-dollar"></i></span>
                <input type="text" class="form-control border-start-0" name="salary" placeholder="ej. 80k - 100k">
              </div>
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold text-muted">Enlace</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0"><i class="bi bi-link-45deg"></i></span>
                <input type="url" class="form-control border-start-0" name="job_link" placeholder="https://...">
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold text-muted">Estado Inicial</label>
              <select class="form-select" name="status">
                <option value="applied">Enviado</option>
                <option value="interviewing">Entrevista</option>
                <option value="negotiating">Negociando</option>
                <option value="accepted">Aceptado</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold text-muted">Interés</label>
              <select class="form-select" name="excitement">
                <option value="1">⭐ (Bajo)</option>
                <option value="2">⭐⭐ (Medio-Bajo)</option>
                <option value="3" selected>⭐⭐⭐ (Medio)</option>
                <option value="4">⭐⭐⭐⭐ (Alto)</option>
                <option value="5">⭐⭐⭐⭐⭐ (Muy Alto)</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-top-0 bg-light">
        <button type="button" class="btn btn-link text-muted text-decoration-none"
          data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary px-4" onclick="saveManualJob()">Guardar Empleo</button>
      </div>
    </div>
  </div>
</div>

<!-- Job Detail Modal -->
<div class="modal fade" id="jobDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-bottom-0 pb-0">
        <h5 class="modal-title fw-bold" id="jobDetailTitle">Detalles</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4" id="jobDetailBody">
        <!-- Details loaded dynamically -->
      </div>
      <div class="modal-footer border-top-0 bg-light justify-content-between">
        <button type="button" class="btn btn-outline-danger" onclick="deleteJob()">
          <i class="bi bi-trash me-2"></i> Eliminar
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
  let currentJobId = null;

  // Load all jobs on page load
  document.addEventListener('DOMContentLoaded', function () {
    loadAllJobs();
  });

  function loadAllJobs() {
    fetch('/api/tracker/jobs')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          renderJobs(data.jobs);
        }
      })
      .catch(error => console.error('Error loading jobs:', error));
  }

  function renderJobs(jobs) {
    // Clear all stages
    const stages = ['applied', 'interviewing', 'negotiating', 'accepted'];
    stages.forEach(stage => {
      document.getElementById(`stage-${stage}`).innerHTML = '';
      document.getElementById(`count-${stage}`).textContent = '0';
    });

    // Group jobs by stage
    const jobsByStage = {};
    stages.forEach(stage => jobsByStage[stage] = []);

    jobs.forEach(job => {
      if (jobsByStage[job.status]) {
        jobsByStage[job.status].push(job);
      }
    });

    // Render jobs in each stage
    Object.keys(jobsByStage).forEach(stage => {
      const stageElement = document.getElementById(`stage-${stage}`);
      const count = jobsByStage[stage].length;

      document.getElementById(`count-${stage}`).textContent = count;

      jobsByStage[stage].forEach(job => {
        const card = createJobCard(job);
        stageElement.appendChild(card);
      });
    });

    // Apply compact view if saved
    const isCompact = localStorage.getItem('trackerCompactView') === 'true';
    if (isCompact) {
      document.querySelectorAll('.job-card').forEach(card => card.classList.add('compact'));
      updateToggleButton(true);
    }

    // Setup drag and drop
    setupDragAndDrop();
  }

  function createJobCard(job) {
    const card = document.createElement('div');
    card.className = 'job-card';
    card.draggable = true;
    card.dataset.jobId = job.id;

    const stars = '⭐'.repeat(job.excitement || 0);
    const appliedDate = job.date_applied ? new Date(job.date_applied).toLocaleDateString() : 'Pendiente';

    card.innerHTML = `
    <div class="job-card-title text-truncate">${job.title}</div>
    <div class="job-card-company">
      <i class="bi bi-building me-2 text-muted"></i> ${job.company}
    </div>
    ${job.location ? `<div class="text-muted mb-1 small"><i class="bi bi-geo-alt me-1"></i> ${job.location}</div>` : ''}
    ${job.salary && job.salary !== 'Not specified' ? `<div class="text-success mb-2 small fw-bold"><i class="bi bi-currency-dollar me-1"></i> ${job.salary}</div>` : ''}
    <div class="job-card-footer">
      <span class="text-warning small" style="letter-spacing: -2px;">${stars}</span>
      <span class="small">${appliedDate}</span>
    </div>
  `;

    card.addEventListener('click', () => showJobDetails(job.id));

    return card;
  }

  function setupDragAndDrop() {
    const cards = document.querySelectorAll('.job-card');
    const stages = document.querySelectorAll('.stage-body');

    cards.forEach(card => {
      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragend', handleDragEnd);
    });

    stages.forEach(stage => {
      stage.addEventListener('dragover', handleDragOver);
      stage.addEventListener('drop', handleDrop);
      stage.addEventListener('dragleave', handleDragLeave);
    });
  }

  function handleDragStart(e) {
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', e.target.innerHTML);
    e.dataTransfer.setData('jobId', e.target.dataset.jobId);
  }

  function handleDragEnd(e) {
    e.target.classList.remove('dragging');
  }

  function handleDragOver(e) {
    if (e.preventDefault) {
      e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    e.currentTarget.classList.add('drag-over');
    return false;
  }

  function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
  }

  function handleDrop(e) {
    if (e.stopPropagation) {
      e.stopPropagation();
    }
    e.preventDefault();

    e.currentTarget.classList.remove('drag-over');

    const jobId = e.dataTransfer.getData('jobId');
    const newStage = e.currentTarget.closest('.stage-column').dataset.stage;

    // Update job status
    updateJobStatus(jobId, newStage);

    return false;
  }

  function updateJobStatus(jobId, newStatus) {
    fetch(`/api/tracker/job/${jobId}/status`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          loadAllJobs(); // Reload to show updated position
        } else {
          console.error('Failed to update status:', data.error);
        }
      })
      .catch(error => console.error('Error updating status:', error));
  }

  function showJobDetails(jobId) {
    currentJobId = jobId;

    fetch(`/api/tracker/job/${jobId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const job = data.job;
          const stars = '⭐'.repeat(job.excitement || 0);

          document.getElementById('jobDetailTitle').textContent = job.title;
          document.getElementById('jobDetailBody').innerHTML = `
          <div class="row g-4">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="small text-muted fw-bold text-uppercase">Empresa</label>
                <div class="fs-5">${job.company}</div>
              </div>
              <div class="mb-3">
                <label class="small text-muted fw-bold text-uppercase">Ubicación</label>
                <div><i class="bi bi-geo-alt me-2"></i> ${job.location || 'No especificada'}</div>
              </div>
              <div class="mb-3">
                <label class="small text-muted fw-bold text-uppercase">Salario</label>
                <div class="text-success fw-bold"><i class="bi bi-currency-dollar me-2"></i> ${job.salary || 'No especificado'}</div>
              </div>
              <div class="mb-3">
                <label class="small text-muted fw-bold text-uppercase">Estado Actual</label>
                <div><span class="badge bg-primary">${job.status}</span></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="small text-muted fw-bold text-uppercase">Fechas</label>
                <div class="small">
                  <div class="mb-1">Guardado: ${new Date(job.date_saved).toLocaleDateString()}</div>
                  <div class="mb-1">Aplicado: ${job.date_applied ? new Date(job.date_applied).toLocaleDateString() : 'Pendiente'}</div>
                  <div>Deadline: ${job.deadline || 'N/A'}</div>
                </div>
              </div>
              <div class="mb-3">
                <label class="small text-muted fw-bold text-uppercase">Interés</label>
                <div class="text-warning">${stars}</div>
              </div>
            </div>
            <div class="col-12">
              <div class="p-3 bg-light rounded">
                <label class="small text-muted fw-bold text-uppercase mb-2">Enlace</label>
                <div class="text-truncate">
                  <a href="${job.job_link}" target="_blank" class="text-decoration-none">
                    <i class="bi bi-box-arrow-up-right me-2"></i> ${job.job_link}
                  </a>
                </div>
              </div>
            </div>
            ${job.notes ? `
            <div class="col-12">
              <label class="small text-muted fw-bold text-uppercase">Notas</label>
              <div class="p-3 border rounded bg-white">${job.notes}</div>
            </div>` : ''}
          </div>
        `;

          new bootstrap.Modal(document.getElementById('jobDetailModal')).show();
        }
      });
  }

  function saveManualJob() {
    const form = document.getElementById('addJobForm');
    const formData = new FormData(form);

    const jobData = {
      title: formData.get('title'),
      company: formData.get('company'),
      location: formData.get('location') || 'Not specified',
      salary: formData.get('salary') || 'Not specified',
      job_link: formData.get('job_link') || '',
      status: formData.get('status'),
      excitement: parseInt(formData.get('excitement')) || 0
    };

    fetch('/api/tracker/job', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(jobData)
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
          form.reset();
          loadAllJobs();
        }
      });
  }

  function deleteJob() {
    if (!currentJobId) return;

    if (confirm('¿Estás seguro de eliminar este empleo?')) {
      fetch(`/api/tracker/job/${currentJobId}`, {
        method: 'DELETE'
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('jobDetailModal')).hide();
            loadAllJobs();
          }
        });
    }
  }

  function toggleCompactView() {
    const cards = document.querySelectorAll('.job-card');
    const isCompact = localStorage.getItem('trackerCompactView') === 'true';
    const newState = !isCompact;
    
    cards.forEach(card => {
      if (newState) {
        card.classList.add('compact');
      } else {
        card.classList.remove('compact');
      }
    });
    
    localStorage.setItem('trackerCompactView', newState);
    updateToggleButton(newState);
  }

  function updateToggleButton(isCompact) {
    const btn = document.getElementById('toggleCompactView');
    if (isCompact) {
      btn.classList.add('active', 'bg-secondary', 'text-white');
      btn.innerHTML = '<i class="bi bi-grid me-2"></i> Vista Normal';
    } else {
      btn.classList.remove('active', 'bg-secondary', 'text-white');
      btn.innerHTML = '<i class="bi bi-list-ul me-2"></i> Vista Compacta';
    }
  }
</script>

{% endblock %}