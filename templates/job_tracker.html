<!-- templates/job_tracker.html -->
{% extends "base.html" %}
{% block content %}

<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üìä Job Application Tracker</h2>
    <div>
      <button class="btn btn-success" onclick="window.location.href='/results'">
        <i class="bi bi-plus-circle"></i> Add Jobs from Results
      </button>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addJobModal">
        <i class="bi bi-plus"></i> Add Manual Job
      </button>
    </div>
  </div>

  <!-- Stage Pipeline -->
  <div class="pipeline-container">
    <div class="row g-3">
      <!-- Bookmarked -->
      <div class="col-md-2">
        <div class="stage-column" data-stage="bookmarked">
          <div class="stage-header bg-secondary text-white">
            <h6 class="mb-0">
              <i class="bi bi-bookmark"></i> BOOKMARKED
              <span class="badge bg-light text-dark" id="count-bookmarked">0</span>
            </h6>
          </div>
          <div class="stage-body" id="stage-bookmarked">
            <!-- Jobs will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Applying -->
      <div class="col-md-2">
        <div class="stage-column" data-stage="applying">
          <div class="stage-header bg-info text-white">
            <h6 class="mb-0">
              <i class="bi bi-pencil"></i> APPLYING
              <span class="badge bg-light text-dark" id="count-applying">0</span>
            </h6>
          </div>
          <div class="stage-body" id="stage-applying">
            <!-- Jobs will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Applied -->
      <div class="col-md-2">
        <div class="stage-column" data-stage="applied">
          <div class="stage-header bg-primary text-white">
            <h6 class="mb-0">
              <i class="bi bi-check-circle"></i> APPLIED
              <span class="badge bg-light text-dark" id="count-applied">0</span>
            </h6>
          </div>
          <div class="stage-body" id="stage-applied">
            <!-- Jobs will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Interviewing -->
      <div class="col-md-2">
        <div class="stage-column" data-stage="interviewing">
          <div class="stage-header bg-warning text-dark">
            <h6 class="mb-0">
              <i class="bi bi-camera-video"></i> INTERVIEWING
              <span class="badge bg-light text-dark" id="count-interviewing">0</span>
            </h6>
          </div>
          <div class="stage-body" id="stage-interviewing">
            <!-- Jobs will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Negotiating -->
      <div class="col-md-2">
        <div class="stage-column" data-stage="negotiating">
          <div class="stage-header bg-orange text-white">
            <h6 class="mb-0">
              <i class="bi bi-currency-dollar"></i> NEGOTIATING
              <span class="badge bg-light text-dark" id="count-negotiating">0</span>
            </h6>
          </div>
          <div class="stage-body" id="stage-negotiating">
            <!-- Jobs will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Accepted -->
      <div class="col-md-2">
        <div class="stage-column" data-stage="accepted">
          <div class="stage-header bg-success text-white">
            <h6 class="mb-0">
              <i class="bi bi-trophy"></i> ACCEPTED
              <span class="badge bg-light text-dark" id="count-accepted">0</span>
            </h6>
          </div>
          <div class="stage-body" id="stage-accepted">
            <!-- Jobs will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Manual Job Modal -->
<div class="modal fade" id="addJobModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Manual Job</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addJobForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Job Position *</label>
              <input type="text" class="form-control" name="title" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Company *</label>
              <input type="text" class="form-control" name="company" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Location</label>
              <input type="text" class="form-control" name="location">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Salary</label>
              <input type="text" class="form-control" name="salary" placeholder="$80,000 - $100,000">
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">Job Link</label>
              <input type="url" class="form-control" name="job_link" placeholder="https://...">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" name="status">
                <option value="bookmarked">Bookmarked</option>
                <option value="applying">Applying</option>
                <option value="applied">Applied</option>
                <option value="interviewing">Interviewing</option>
                <option value="negotiating">Negotiating</option>
                <option value="accepted">Accepted</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Excitement Level</label>
              <select class="form-select" name="excitement">
                <option value="1">‚≠ê (1 star)</option>
                <option value="2">‚≠ê‚≠ê (2 stars)</option>
                <option value="3">‚≠ê‚≠ê‚≠ê (3 stars)</option>
                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 stars)</option>
                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 stars)</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveManualJob()">Save Job</button>
      </div>
    </div>
  </div>
</div>

<!-- Job Detail Modal -->
<div class="modal fade" id="jobDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="jobDetailTitle">Job Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="jobDetailBody">
        <!-- Details loaded dynamically -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" onclick="deleteJob()">Delete</button>
      </div>
    </div>
  </div>
</div>

<style>
.pipeline-container {
  overflow-x: auto;
  padding-bottom: 20px;
}

.stage-column {
  background: #f8f9fa;
  border-radius: 8px;
  min-height: 600px;
  display: flex;
  flex-direction: column;
}

.stage-header {
  padding: 12px;
  border-radius: 8px 8px 0 0;
  font-size: 0.85rem;
  font-weight: 600;
}

.stage-body {
  padding: 10px;
  flex: 1;
  overflow-y: auto;
  max-height: 70vh;
}

.job-card {
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.job-card:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.job-card.dragging {
  opacity: 0.5;
}

.job-card-title {
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 4px;
  color: #212529;
}

.job-card-company {
  font-size: 0.85rem;
  color: #6c757d;
  margin-bottom: 8px;
}

.job-card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.75rem;
  color: #6c757d;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #e9ecef;
}

.excitement-stars {
  color: #ffc107;
}

.bg-orange {
  background-color: #fd7e14 !important;
}

.stage-body.drag-over {
  background-color: #e3f2fd;
  border: 2px dashed #2196F3;
}
</style>

<script>
let currentJobId = null;

// Load all jobs on page load
document.addEventListener('DOMContentLoaded', function() {
  loadAllJobs();
});

function loadAllJobs() {
  fetch('/api/tracker/jobs')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        renderJobs(data.jobs);
      }
    })
    .catch(error => console.error('Error loading jobs:', error));
}

function renderJobs(jobs) {
  // Clear all stages
  const stages = ['bookmarked', 'applying', 'applied', 'interviewing', 'negotiating', 'accepted'];
  stages.forEach(stage => {
    document.getElementById(`stage-${stage}`).innerHTML = '';
    document.getElementById(`count-${stage}`).textContent = '0';
  });

  // Group jobs by stage
  const jobsByStage = {};
  stages.forEach(stage => jobsByStage[stage] = []);
  
  jobs.forEach(job => {
    if (jobsByStage[job.status]) {
      jobsByStage[job.status].push(job);
    }
  });

  // Render jobs in each stage
  Object.keys(jobsByStage).forEach(stage => {
    const stageElement = document.getElementById(`stage-${stage}`);
    const count = jobsByStage[stage].length;
    
    document.getElementById(`count-${stage}`).textContent = count;
    
    jobsByStage[stage].forEach(job => {
      const card = createJobCard(job);
      stageElement.appendChild(card);
    });
  });

  // Setup drag and drop
  setupDragAndDrop();
}

function createJobCard(job) {
  const card = document.createElement('div');
  card.className = 'job-card';
  card.draggable = true;
  card.dataset.jobId = job.id;
  
  const stars = '‚≠ê'.repeat(job.excitement || 0);
  const appliedDate = job.date_applied ? new Date(job.date_applied).toLocaleDateString() : 'N/A';
  
  card.innerHTML = `
    <div class="job-card-title">${job.title}</div>
    <div class="job-card-company">${job.company}</div>
    ${job.location ? `<div class="text-muted" style="font-size: 0.75rem;"><i class="bi bi-geo-alt"></i> ${job.location}</div>` : ''}
    ${job.salary && job.salary !== 'Not specified' ? `<div class="text-success" style="font-size: 0.75rem;"><i class="bi bi-currency-dollar"></i> ${job.salary}</div>` : ''}
    <div class="job-card-footer">
      <span class="excitement-stars">${stars}</span>
      <span>${appliedDate}</span>
    </div>
  `;
  
  card.addEventListener('click', () => showJobDetails(job.id));
  
  return card;
}

function setupDragAndDrop() {
  const cards = document.querySelectorAll('.job-card');
  const stages = document.querySelectorAll('.stage-body');
  
  cards.forEach(card => {
    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragend', handleDragEnd);
  });
  
  stages.forEach(stage => {
    stage.addEventListener('dragover', handleDragOver);
    stage.addEventListener('drop', handleDrop);
    stage.addEventListener('dragleave', handleDragLeave);
  });
}

function handleDragStart(e) {
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', e.target.innerHTML);
  e.dataTransfer.setData('jobId', e.target.dataset.jobId);
}

function handleDragEnd(e) {
  e.target.classList.remove('dragging');
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.classList.add('drag-over');
  return false;
}

function handleDragLeave(e) {
  e.currentTarget.classList.remove('drag-over');
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  e.preventDefault();
  
  e.currentTarget.classList.remove('drag-over');
  
  const jobId = e.dataTransfer.getData('jobId');
  const newStage = e.currentTarget.closest('.stage-column').dataset.stage;
  
  // Update job status
  updateJobStatus(jobId, newStage);
  
  return false;
}

function updateJobStatus(jobId, newStatus) {
  console.log(`Updating job ${jobId} to status: ${newStatus}`);
  fetch(`/api/tracker/job/${jobId}/status`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status: newStatus })
  })
  .then(response => {
    console.log('Response status:', response.status);
    return response.json();
  })
  .then(data => {
    console.log('Response data:', data);
    if (data.success) {
      console.log('Status updated successfully, reloading jobs...');
      loadAllJobs(); // Reload to show updated position
    } else {
      console.error('Failed to update status:', data.error);
    }
  })
  .catch(error => console.error('Error updating status:', error));
}

function showJobDetails(jobId) {
  currentJobId = jobId;
  
  fetch(`/api/tracker/job/${jobId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const job = data.job;
        const stars = '‚≠ê'.repeat(job.excitement || 0);
        
        document.getElementById('jobDetailTitle').textContent = job.title;
        document.getElementById('jobDetailBody').innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <p><strong>Company:</strong> ${job.company}</p>
              <p><strong>Location:</strong> ${job.location || 'Not specified'}</p>
              <p><strong>Salary:</strong> ${job.salary || 'Not specified'}</p>
              <p><strong>Status:</strong> <span class="badge bg-primary">${job.status}</span></p>
            </div>
            <div class="col-md-6">
              <p><strong>Date Saved:</strong> ${new Date(job.date_saved).toLocaleDateString()}</p>
              <p><strong>Date Applied:</strong> ${job.date_applied ? new Date(job.date_applied).toLocaleDateString() : 'N/A'}</p>
              <p><strong>Deadline:</strong> ${job.deadline || 'N/A'}</p>
              <p><strong>Excitement:</strong> ${stars}</p>
            </div>
            <div class="col-12 mt-3">
              <p><strong>Job Link:</strong> <a href="${job.job_link}" target="_blank">${job.job_link}</a></p>
            </div>
            ${job.notes ? `<div class="col-12 mt-3"><p><strong>Notes:</strong></p><p>${job.notes}</p></div>` : ''}
          </div>
        `;
        
        new bootstrap.Modal(document.getElementById('jobDetailModal')).show();
      }
    });
}

function saveManualJob() {
  const form = document.getElementById('addJobForm');
  const formData = new FormData(form);
  
  const jobData = {
    title: formData.get('title'),
    company: formData.get('company'),
    location: formData.get('location') || 'Not specified',
    salary: formData.get('salary') || 'Not specified',
    job_link: formData.get('job_link') || '',
    status: formData.get('status'),
    excitement: parseInt(formData.get('excitement')) || 0
  };
  
  fetch('/api/tracker/job', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(jobData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
      form.reset();
      loadAllJobs();
    }
  });
}

function deleteJob() {
  if (!currentJobId) return;
  
  if (confirm('Are you sure you want to delete this job?')) {
    fetch(`/api/tracker/job/${currentJobId}`, {
      method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        bootstrap.Modal.getInstance(document.getElementById('jobDetailModal')).hide();
        loadAllJobs();
      }
    });
  }
}
</script>

{% endblock %}

