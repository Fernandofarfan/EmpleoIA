{% extends "base.html" %}
{% block content %}
<div class="row mt-4">
  <!-- Sidebar: Status & Info -->
  <div class="col-lg-4 mb-4">
    <!-- Profile Status Card -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body p-4">
        <h5 class="fw-bold mb-4">
          <i class="bi bi-person-badge me-2 text-primary"></i> Estado de Perfiles
        </h5>

        <div class="text-center mb-4">
          <div class="position-relative d-inline-block">
            <svg width="120" height="120">
              <circle cx="60" cy="60" r="54" fill="none" stroke="#e5e7eb" stroke-width="8" />
              <circle id="progressCircle" cx="60" cy="60" r="54" fill="none" stroke="#4f46e5" stroke-width="8"
                stroke-dasharray="339.292" stroke-dashoffset="339.292" transform="rotate(-90 60 60)"
                style="transition: stroke-dashoffset 1s ease" />
            </svg>
            <div class="position-absolute top-50 start-50 translate-middle text-center">
              <div class="fs-3 fw-bold text-primary" id="total-profiles">0</div>
              <div class="small text-muted">Perfiles</div>
            </div>
          </div>
        </div>

        <hr class="my-3 opacity-10">

        <div id="profile-summary" class="d-flex flex-column gap-3">
          <div class="d-flex justify-content-between align-items-center">
            <span class="small fw-medium">
              <i class="bi bi-bar-chart me-2 text-muted"></i>Data Analyst
            </span>
            <span id="status-analyst" class="badge bg-light text-muted border">Pendiente</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="small fw-medium">
              <i class="bi bi-gear me-2 text-muted"></i>Data Engineer
            </span>
            <span id="status-engineer" class="badge bg-light text-muted border">Pendiente</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="small fw-medium">
              <i class="bi bi-clipboard-data me-2 text-muted"></i>Data Scientist
            </span>
            <span id="status-scientist" class="badge bg-light text-muted border">Pendiente</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="small fw-medium">
              <i class="bi bi-robot me-2 text-muted"></i>AI/ML Engineer
            </span>
            <span id="status-ai" class="badge bg-light text-muted border">Pendiente</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="small fw-medium">
              <i class="bi bi-file-text me-2 text-muted"></i>Otros
            </span>
            <span id="status-other" class="badge bg-light text-muted border">Pendiente</span>
          </div>
        </div>
      </div>
    </div>

    <!-- How it Works Card -->
    <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      <div class="card-body p-4 text-white">
        <h6 class="fw-bold mb-3">
          <i class="bi bi-lightning-charge me-2"></i> ¬øC√≥mo funciona?
        </h6>
        <ul class="list-unstyled small mb-0 d-flex flex-column gap-2">
          <li class="d-flex">
            <i class="bi bi-check-circle-fill me-2 mt-1 opacity-75"></i>
            <span>Sube un CV espec√≠fico para cada rol que busques.</span>
          </li>
          <li class="d-flex">
            <i class="bi bi-check-circle-fill me-2 mt-1 opacity-75"></i>
            <span>El sistema extrae tus habilidades autom√°ticamente.</span>
          </li>
          <li class="d-flex">
            <i class="bi bi-check-circle-fill me-2 mt-1 opacity-75"></i>
            <span>Las ofertas se emparejan con el CV m√°s adecuado.</span>
          </li>
          <li class="d-flex">
            <i class="bi bi-check-circle-fill me-2 mt-1 opacity-75"></i>
            <span>Solo ver√°s empleos con +60% de coincidencia.</span>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Main Content: Upload & List -->
  <div class="col-lg-8">
    <!-- Upload Section with Drag & Drop -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
        <h4 class="fw-bold mb-0">Cargar Nuevo CV</h4>
      </div>
      <div class="card-body p-4">
        <form action="/upload_resume" method="post" enctype="multipart/form-data" id="uploadForm">
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label small fw-bold text-muted">1. Tipo de Rol</label>
              <select class="form-select" id="role_type" name="role_type" required>
                <option value="">Seleccionar Rol...</option>
                <option value="data_analyst">üìä Data Analyst</option>
                <option value="data_engineer">‚öôÔ∏è Data Engineer</option>
                <option value="data_scientist">üî¨ Data Scientist</option>
                <option value="ai_engineer">ü§ñ AI/ML Engineer</option>
                <option value="other">üìÑ Otros</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold text-muted">3. Habilidades Adicionales (Opcional)</label>
              <input type="text" class="form-control" id="additional_skills" name="additional_skills"
                placeholder="ej. AWS, Docker, Kubernetes" />
              <div class="form-text small">Se sumar√°n a las detectadas autom√°ticamente.</div>
            </div>
          </div>

          <!-- Drag & Drop Zone -->
          <div class="mb-4">
            <label class="form-label small fw-bold text-muted">2. Archivo (PDF/DOCX)</label>
            <div id="dropZone" class="drop-zone">
              <input type="file" class="d-none" id="resume" name="resume" accept=".pdf,.docx,.txt" required />
              <div id="dropZoneContent" class="drop-zone-content">
                <i class="bi bi-cloud-arrow-up display-1 text-primary mb-3"></i>
                <h5 class="fw-bold mb-2">Arrastra tu CV aqu√≠</h5>
                <p class="text-muted mb-3">o haz clic para seleccionar</p>
                <button type="button" class="btn btn-outline-primary"
                  onclick="document.getElementById('resume').click()">
                  <i class="bi bi-folder2-open me-2"></i>Seleccionar Archivo
                </button>
                <p class="small text-muted mt-3 mb-0">Formatos soportados: PDF, DOCX, TXT (M√°x. 10MB)</p>
              </div>
              <div id="filePreview" class="file-preview" style="display: none;">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center gap-3">
                    <div class="file-icon">
                      <i class="bi bi-file-earmark-pdf-fill fs-1 text-danger"></i>
                    </div>
                    <div>
                      <div class="fw-bold" id="fileName"></div>
                      <div class="small text-muted" id="fileSize"></div>
                    </div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile()">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100 py-3" id="submitBtn">
            <i class="bi bi-cloud-arrow-up me-2"></i> Subir y Analizar CV
          </button>
        </form>
      </div>
    </div>

    <!-- Active Profiles List -->
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0 pt-4 px-4 pb-0 d-flex justify-content-between align-items-center">
        <h4 class="fw-bold mb-0">Mis Perfiles Activos</h4>
        <button class="btn btn-sm btn-outline-secondary" onclick="loadAllProfiles()">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
      <div class="card-body p-0">
        <div id="profilesContainer">
          <div class="text-center py-5">
            <div class="spinner-border spinner-border-sm text-primary mb-2" role="status"></div>
            <div class="small text-muted">Cargando perfiles...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Drag & Drop Zone */
  .drop-zone {
    border: 3px dashed #e5e7eb;
    border-radius: 16px;
    padding: 3rem 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    background: #f9fafb;
  }

  .drop-zone:hover {
    border-color: #4f46e5;
    background: #eef2ff;
  }

  .drop-zone.dragover {
    border-color: #4f46e5;
    background: #eef2ff;
    transform: scale(1.02);
  }

  .drop-zone-content {
    pointer-events: none;
  }

  .file-preview {
    padding: 1.5rem;
    background: white;
    border-radius: 12px;
  }

  .file-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fee2e2;
    border-radius: 12px;
  }

  /* Profile Cards */
  .profile-card {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    transition: all 0.2s ease;
  }

  .profile-card:hover {
    background: #f9fafb;
  }

  .profile-card:last-child {
    border-bottom: none;
  }

  .skill-badge {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 6px;
    font-size: 0.8125rem;
    font-weight: 600;
    margin: 0.25rem;
  }

  /* Progress Circle Animation */
  @keyframes fillCircle {
    from {
      stroke-dashoffset: 339.292;
    }

    to {
      stroke-dashoffset: var(--progress-offset);
    }
  }

  /* Smooth Transitions */
  .fade-in {
    animation: fadeIn 0.5s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    loadAllProfiles();
    setupDragAndDrop();
  });

  function setupDragAndDrop() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('resume');

    dropZone.addEventListener('click', () => fileInput.click());

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
    });

    dropZone.addEventListener('drop', handleDrop, false);
    fileInput.addEventListener('change', handleFileSelect, false);
  }

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    document.getElementById('resume').files = files;
    handleFileSelect({ target: { files } });
  }

  function handleFileSelect(e) {
    const file = e.target.files[0];
    if (!file) return;

    const dropZoneContent = document.getElementById('dropZoneContent');
    const filePreview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');

    dropZoneContent.style.display = 'none';
    filePreview.style.display = 'block';

    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);

    // Update icon based on file type
    const icon = filePreview.querySelector('.file-icon i');
    if (file.name.endsWith('.pdf')) {
      icon.className = 'bi bi-file-earmark-pdf-fill fs-1 text-danger';
    } else if (file.name.endsWith('.docx')) {
      icon.className = 'bi bi-file-earmark-word-fill fs-1 text-primary';
    } else {
      icon.className = 'bi bi-file-earmark-text-fill fs-1 text-secondary';
    }
  }

  function removeFile() {
    document.getElementById('resume').value = '';
    document.getElementById('dropZoneContent').style.display = 'block';
    document.getElementById('filePreview').style.display = 'none';
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  function loadAllProfiles() {
    fetch("/api/all_profiles")
      .then((response) => response.json())
      .then((data) => {
        updateProfilesDisplay(data.profiles);
        updateStatusSummary(data.profiles);
        updateProgressCircle(data.profiles);
      })
      .catch((error) => {
        console.error("Error loading profiles:", error);
        document.getElementById("profilesContainer").innerHTML = `
          <div class="text-center py-5 text-muted">
            <i class="bi bi-exclamation-circle fs-4 d-block mb-2"></i>
            Error al cargar perfiles.
          </div>
        `;
      });
  }

  function updateProgressCircle(profiles) {
    const total = 5; // Total possible profiles
    const active = Object.keys(profiles).length;
    const percentage = (active / total) * 100;
    const circumference = 339.292;
    const offset = circumference - (percentage / 100) * circumference;

    const circle = document.getElementById('progressCircle');
    circle.style.strokeDashoffset = offset;
  }

  function updateProfilesDisplay(profiles) {
    const container = document.getElementById("profilesContainer");

    if (Object.keys(profiles).length === 0) {
      container.innerHTML = `
        <div class="text-center py-5 text-muted">
          <i class="bi bi-folder2-open fs-1 d-block mb-3 opacity-50"></i>
          <h6 class="fw-bold">No hay perfiles cargados</h6>
          <p class="small mb-0">¬°Sube tu primer CV arriba!</p>
        </div>
      `;
      return;
    }

    const roleIcons = {
      data_analyst: "üìä",
      data_engineer: "‚öôÔ∏è",
      data_scientist: "üî¨",
      ai_engineer: "ü§ñ",
      other: "üìÑ",
    };

    const roleNames = {
      data_analyst: "Data Analyst",
      data_engineer: "Data Engineer",
      data_scientist: "Data Scientist",
      ai_engineer: "AI/ML Engineer",
      other: "Otros",
    };

    container.innerHTML = "";

    for (const [roleType, profile] of Object.entries(profiles)) {
      const uploadDate = new Date(profile.upload_date).toLocaleDateString('es-AR', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
      const skillsCount = profile.skills ? profile.skills.length : 0;
      const resumeFilename = profile.resume_filename || "Desconocido";

      const card = document.createElement('div');
      card.className = 'profile-card fade-in';
      card.innerHTML = `
        <div class="d-flex align-items-start justify-content-between">
          <div class="d-flex align-items-start gap-3 flex-grow-1">
            <div class="rounded p-3 bg-light fs-1">${roleIcons[roleType] || "üìÑ"}</div>
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 mb-2">
                <h5 class="fw-bold mb-0">${roleNames[roleType] || roleType}</h5>
                <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                  <i class="bi bi-check-circle me-1"></i>Activo
                </span>
              </div>
              <div class="small text-muted mb-2">
                <i class="bi bi-paperclip me-1"></i>${resumeFilename.substring(0, 40)}${resumeFilename.length > 40 ? '...' : ''}
              </div>
              <div class="small text-muted mb-3">
                <i class="bi bi-calendar me-1"></i>Subido: ${uploadDate}
              </div>
              ${profile.skills && profile.skills.length > 0 ? `
              <div class="mb-2">
                <div class="small fw-bold text-muted mb-2">Habilidades detectadas:</div>
                <div class="d-flex flex-wrap gap-1">
                  ${profile.skills.slice(0, 8).map(skill => `
                    <span class="skill-badge">${skill}</span>
                  `).join('')}
                  ${profile.skills.length > 8 ? `
                    <span class="badge bg-light text-dark border">+${profile.skills.length - 8} m√°s</span>
                  ` : ''}
                </div>
              </div>
              ` : ''}
            </div>
          </div>
          <div class="d-flex gap-2">
            <a href="/view_profile/${roleType}" class="btn btn-sm btn-outline-primary" title="Ver Detalles">
              <i class="bi bi-eye"></i>
            </a>
            <a href="/delete_profile/${roleType}" class="btn btn-sm btn-outline-danger" 
               title="Eliminar" onclick="return confirm('¬øEliminar este perfil?')">
              <i class="bi bi-trash"></i>
            </a>
          </div>
        </div>
      `;

      container.appendChild(card);
    }
  }

  function updateStatusSummary(profiles) {
    document.getElementById("total-profiles").textContent = Object.keys(profiles).length;

    const roleKeys = {
      data_analyst: "status-analyst",
      data_engineer: "status-engineer",
      data_scientist: "status-scientist",
      ai_engineer: "status-ai",
      other: "status-other",
    };

    for (const [roleType, elementId] of Object.entries(roleKeys)) {
      const statusElement = document.getElementById(elementId);
      if (statusElement) {
        if (profiles[roleType]) {
          statusElement.textContent = "Activo";
          statusElement.className = "badge bg-success bg-opacity-10 text-success border border-success border-opacity-25";
          statusElement.innerHTML = '<i class="bi bi-check-circle me-1"></i> Activo';
        } else {
          statusElement.textContent = "Pendiente";
          statusElement.className = "badge bg-light text-muted border";
          statusElement.innerHTML = 'Pendiente';
        }
      }
    }
  }
</script>
{% endblock %}