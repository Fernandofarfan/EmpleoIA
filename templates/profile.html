<!-- templates/profile.html -->
{% extends "base.html" %} {% block content %}
<div class="container mt-4">
  <h2 class="mb-4">üìã Multi-Resume Profile Manager</h2>

  <div class="row">
    <!-- Upload Form -->
    <div class="col-md-8">
      <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">
          <h4 class="mb-0">
            <i class="bi bi-upload"></i> Upload Resume
          </h4>
        </div>
        <div class="card-body">
          <form action="/upload_resume" method="post" enctype="multipart/form-data">
            <!-- Step 1: Select Role Type -->
            <div class="mb-3">
              <label for="role_type" class="form-label">
                <strong>Step 1:</strong> Select Role Type
              </label>
              <select class="form-select" id="role_type" name="role_type" required>
                <option value="">-- Choose Role --</option>
                <option value="data_analyst">üìä Data Analyst</option>
                <option value="data_engineer">‚öôÔ∏è Data Engineer</option>
                <option value="data_scientist">üî¨ Data Scientist</option>
                <option value="ai_engineer">ü§ñ AI/ML Engineer</option>
                <option value="other">üìÑ Otros</option>
              </select>
              <div class="form-text">
                Choose the role that matches this resume
              </div>
            </div>

            <!-- Step 2: Upload Resume File -->
            <div class="mb-3">
              <label for="resume" class="form-label">
                <strong>Step 2:</strong> Upload Resume File
              </label>
              <input type="file" class="form-control" id="resume" name="resume" accept=".pdf,.docx,.txt" required />
              <div class="form-text">
                Supported formats: PDF, DOCX, TXT (Max size: 16MB)
              </div>
            </div>

            <!-- Step 3: Optional Additional Skills -->
            <div class="mb-3">
              <label for="additional_skills" class="form-label">
                <strong>Step 3:</strong> Additional Skills (Optional)
              </label>
              <input type="text" class="form-control" id="additional_skills" name="additional_skills"
                placeholder="e.g., AWS, Docker, Kubernetes, TensorFlow (comma-separated)" />
              <div class="form-text">
                Skills will be auto-extracted from your resume, but you can add
                more here
              </div>
            </div>

            <button type="submit" class="btn btn-success btn-lg">
              <i class="bi bi-upload"></i> Upload and Parse Resume
            </button>
          </form>
        </div>
      </div>

      <!-- Current Resume Profiles Table -->
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="bi bi-folder"></i> Your Resume Profiles
          </h4>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Role Type</th>
                  <th>Resume File</th>
                  <th>Skills</th>
                  <th>Experience</th>
                  <th>Upload Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="profiles-table-body">
                <tr>
                  <td colspan="6" class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    Loading profiles...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- How it Works Sidebar -->
    <div class="col-md-4">
      <div class="card shadow">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="bi bi-info-circle"></i> How it Works</h5>
        </div>
        <div class="card-body">
          <ol class="small">
            <li>
              <strong>Upload multiple resumes</strong> - One for each role type
              (Data Analyst, Engineer, Scientist, AI)
            </li>
            <li>
              <strong>Auto skill extraction</strong> - System extracts skills,
              experience, education
            </li>
            <li>
              <strong>Smart job matching</strong> - Jobs are auto-matched to the
              right resume
            </li>
            <li>
              <strong>60% match threshold</strong> - Only relevant jobs are
              scraped
            </li>
            <li>
              <strong>Get match scores</strong> - See percentage match for each
              job
            </li>
          </ol>
        </div>
      </div>

      <div class="card shadow mt-3">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">
            <i class="bi bi-bar-chart"></i> Current Status
          </h5>
        </div>
        <div class="card-body">
          <div id="profile-summary">
            <div class="mb-2">
              <strong>Total Profiles:</strong>
              <span id="total-profiles" class="badge bg-primary float-end">
                0
              </span>
            </div>
            <div class="mb-2">
              <strong>Data Analyst:</strong>
              <span id="status-analyst" class="badge bg-secondary float-end">
                Not uploaded
              </span>
            </div>
            <div class="mb-2">
              <strong>Data Engineer:</strong>
              <span id="status-engineer" class="badge bg-secondary float-end">
                Not uploaded
              </span>
            </div>
            <div class="mb-2">
              <strong>Data Scientist:</strong>
              <span id="status-scientist" class="badge bg-secondary float-end">
                Not uploaded
              </span>
            </div>
            <div class="mb-2">
              <strong>AI/ML Engineer:</strong>
              <span id="status-ai" class="badge bg-secondary float-end">
                Not uploaded
              </span>
            </div>
            <div class="mb-2">
              <strong>Otros:</strong>
              <span id="status-other" class="badge bg-secondary float-end">
                Not uploaded
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    loadAllProfiles();
  });

  function loadAllProfiles() {
    fetch("/api/all_profiles")
      .then((response) => response.json())
      .then((data) => {
        updateProfilesTable(data.profiles);
        updateStatusSummary(data.profiles);
      })
      .catch((error) => {
        console.error("Error loading profiles:", error);
        document.getElementById("profiles-table-body").innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-muted">
              No resumes uploaded yet. Upload your first resume above!
            </td>
          </tr>
        `;
      });
  }

  function updateProfilesTable(profiles) {
    const tableBody = document.getElementById("profiles-table-body");

    if (Object.keys(profiles).length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center text-muted">
            <i class="bi bi-inbox"></i> No resumes uploaded yet. Upload your first resume above!
          </td>
        </tr>
      `;
      return;
    }

    const roleIcons = {
      data_analyst: "üìä",
      data_engineer: "‚öôÔ∏è",
      data_scientist: "üî¨",
      ai_engineer: "ü§ñ",
      other: "üìÑ",
    };

    const roleNames = {
      data_analyst: "Data Analyst",
      data_engineer: "Data Engineer",
      data_scientist: "Data Scientist",
      ai_engineer: "AI/ML Engineer",
      other: "Otros",
    };

    tableBody.innerHTML = "";

    for (const [roleType, profile] of Object.entries(profiles)) {
      const row = document.createElement("tr");

      const uploadDate = new Date(profile.upload_date).toLocaleDateString();
      const skillsCount = profile.skills ? profile.skills.length : 0;
      const experience = profile.experience_years || "N/A";
      const resumeFilename = profile.resume_filename || "Unknown";

      row.innerHTML = `
        <td>
          <span class="badge bg-info">
            ${roleIcons[roleType] || "üìÑ"} ${roleNames[roleType] || roleType}
          </span>
        </td>
        <td>
          <small>${resumeFilename.substring(0, 30)}...</small>
        </td>
        <td>${skillsCount} skills</td>
        <td>${experience} years</td>
        <td>${uploadDate}</td>
        <td>
          <a href="/view_profile/${roleType}" class="btn btn-sm btn-primary me-1">
            <i class="bi bi-eye"></i> View
          </a>
          <a href="/delete_profile/${roleType}" class="btn btn-sm btn-danger">
            <i class="bi bi-trash"></i> Delete
          </a>
        </td>
      `;

      tableBody.appendChild(row);
    }
  }

  function updateStatusSummary(profiles) {
    document.getElementById("total-profiles").textContent =
      Object.keys(profiles).length;

    const roleKeys = {
      data_analyst: "status-analyst",
      data_engineer: "status-engineer",
      data_scientist: "status-scientist",
      ai_engineer: "status-ai",
      other: "status-other",
    };

    for (const [roleType, elementId] of Object.entries(roleKeys)) {
      const statusElement = document.getElementById(elementId);
      if (profiles[roleType]) {
        statusElement.textContent = "‚úì Uploaded";
        statusElement.className = "badge bg-success float-end";
      } else {
        statusElement.textContent = "Not uploaded";
        statusElement.className = "badge bg-secondary float-end";
      }
    }
  }
</script>
{% endblock %}