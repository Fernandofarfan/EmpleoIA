<!-- job_scraper_app/templates/scraper.html -->
{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">Buscar Empleos</h2>

<!-- Resume Upload Notice -->
<div class="alert alert-info mb-4">
  <div class="d-flex align-items-center">
    <i class="bi bi-info-circle me-2"></i>
    <div>
      <strong>¬°Antes de buscar empleos, carg√° tu curr√≠culum para optimizaci√≥n con IA!</strong>
      <br>
      <small class="text-muted">And√° a la p√°gina de <a href="/profile" class="alert-link">Perfil</a> para cargar tu CV.
        Esto habilita la optimizaci√≥n con IA para cada empleo que extraigas.</small>
    </div>
  </div>
</div>


<!-- Universal Scraper - Search All Platforms -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow border-warning">
      <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h3 class="mb-0"><i class="bi bi-globe2"></i> üöÄ Scraper Universal - Buscar en Todas las Plataformas</h3>
        <small>Ejecuta Indeed, LinkedIn, Computrabajo y Bumeran simult√°neamente</small>
      </div>
      <div class="card-body">
        <div class="job-status-container mb-3">
          <div id="universal-status-box">
            <div class="d-flex justify-content-between mb-2">
              <span><strong>Estado:</strong> <span id="universal-status">Inactivo</span></span>
            </div>
            <div class="progress mb-2" style="height: 25px;">
              <div id="universal-progress" class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 0%">0%</div>
            </div>
            <p id="universal-message" class="small text-muted"></p>
            
            <!-- Individual scraper status -->
            <div class="row mt-3" id="universal-scrapers-status">
              <div class="col-md-3 col-sm-6 mb-2">
                <div class="card border-primary">
                  <div class="card-body p-2 text-center">
                    <small class="text-muted">Indeed</small>
                    <div><span id="universal-indeed-status" class="badge bg-secondary">Esperando</span></div>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-sm-6 mb-2">
                <div class="card border-info">
                  <div class="card-body p-2 text-center">
                    <small class="text-muted">LinkedIn</small>
                    <div><span id="universal-linkedin-status" class="badge bg-secondary">Esperando</span></div>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-sm-6 mb-2">
                <div class="card border-danger">
                  <div class="card-body p-2 text-center">
                    <small class="text-muted">Computrabajo</small>
                    <div><span id="universal-computrabajo-status" class="badge bg-secondary">Esperando</span></div>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-sm-6 mb-2">
                <div class="card border-success">
                  <div class="card-body p-2 text-center">
                    <small class="text-muted">Bumeran</small>
                    <div><span id="universal-bumeran-status" class="badge bg-secondary">Esperando</span></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <form action="/start_universal_scraper" method="post">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label"><strong>Puesto / Palabras Clave</strong></label>
              <input type="text" class="form-control form-control-lg" name="position" placeholder="ej. Python Developer" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label"><strong>Ubicaci√≥n</strong></label>
              <input type="text" class="form-control form-control-lg" name="location" placeholder="ej. Buenos Aires, Argentina">
            </div>
          </div>

          <button type="submit" class="btn btn-lg w-100 text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="bi bi-rocket-takeoff"></i> Iniciar B√∫squeda Universal
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Indeed Scraper -->
  <div class="col-md-6">
    <div class="card mb-4 shadow">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="bi bi-briefcase"></i> Scraper de Indeed</h4>
      </div>
      <div class="card-body">
        <div class="job-status-container mb-3">
          <div id="indeed-status-box">
            <div class="d-flex justify-content-between mb-2">
              <span><strong>Estado:</strong> <span id="indeed-status">Inactivo</span></span>
            </div>
            <div class="progress mb-2">
              <div id="indeed-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <p id="indeed-message" class="small text-muted"></p>
          </div>
        </div>

        <form action="/start_indeed_scraper" method="post">
          <div id="indeed-search-params">
            <div class="search-row mb-3 p-3 border rounded bg-light position-relative">
              <div class="mb-2">
                <label class="form-label">Puesto / Palabras Clave</label>
                <input type="text" class="form-control" name="position[]" placeholder="ej. Python Developer" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Ubicaci√≥n</label>
                <input type="text" class="form-control" name="location[]" placeholder="ej. Buenos Aires, Argentina">
              </div>
              <div class="mb-2">
                <label class="form-label">P√°ginas a Escanear</label>
                <input type="number" class="form-control" name="pages" value="1" min="1" max="5">
              </div>
              <button type="button"
                class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2 remove-search"
                title="Eliminar b√∫squeda">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>

          <div class="d-flex justify-content-between mb-3">
            <button type="button" class="btn btn-outline-primary btn-sm" id="add-indeed-search">
              <i class="bi bi-plus-circle"></i> Agregar B√∫squeda
            </button>
          </div>

          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-search"></i> Iniciar Scraper de Indeed
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- LinkedIn Scraper -->
  <div class="col-md-6">
    <div class="card mb-4 shadow">
      <div class="card-header bg-info text-white">
        <h4 class="mb-0"><i class="bi bi-linkedin"></i> Scraper de LinkedIn</h4>
      </div>
      <div class="card-body">
        <div class="job-status-container mb-3">
          <div id="linkedin-status-box">
            <div class="d-flex justify-content-between mb-2">
              <span><strong>Estado:</strong> <span id="linkedin-status">Inactivo</span></span>
            </div>
            <div class="progress mb-2">
              <div id="linkedin-progress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
            </div>
            <p id="linkedin-message" class="small text-muted"></p>
          </div>
        </div>

        <form action="/start_linkedin_scraper" method="post">
          <div id="linkedin-search-params">
            <div class="search-row mb-3 p-3 border rounded bg-light position-relative">
              <div class="mb-2">
                <label class="form-label">Puesto / Palabras Clave</label>
                <input type="text" class="form-control" name="position[]" placeholder="ej. Software Engineer" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Ubicaci√≥n</label>
                <input type="text" class="form-control" name="location[]" placeholder="ej. Argentina">
              </div>
              <button type="button"
                class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2 remove-search"
                title="Eliminar b√∫squeda">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>

          <div class="d-flex justify-content-between mb-3">
            <button type="button" class="btn btn-outline-info btn-sm" id="add-linkedin-search">
              <i class="bi bi-plus-circle"></i> Agregar B√∫squeda
            </button>
          </div>

          <div class="mb-3">
            <button type="button" class="btn btn-outline-secondary btn-sm w-100"
              onclick="toggleFilters('linkedin-filters')" id="toggle-linkedin-filters">
              Filtros Avanzados
            </button>
            <div id="linkedin-filters" class="mt-3 p-3 border rounded" style="display: none;">
              <div class="mb-2">
                <label class="form-label">Token de Autenticaci√≥n de LinkedIn (li_at)</label>
                <input type="text" class="form-control" name="linkedin_token">
                <div class="form-text">La cookie li_at es necesaria para acceder a LinkedIn.</div>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-info text-white w-100">
            <i class="bi bi-linkedin"></i> Iniciar Scraper de LinkedIn
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Computrabajo Scraper -->
  <div class="col-md-6">
    <div class="card mb-4 shadow">
      <div class="card-header bg-danger text-white">
        <h4 class="mb-0"><i class="bi bi-briefcase-fill"></i> Scraper de Computrabajo</h4>
      </div>
      <div class="card-body">
        <div class="job-status-container mb-3">
          <div id="computrabajo-status-box">
            <div class="d-flex justify-content-between mb-2">
              <span><strong>Estado:</strong> <span id="computrabajo-status">Inactivo</span></span>
            </div>
            <div class="progress mb-2">
              <div id="computrabajo-progress" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
            </div>
            <p id="computrabajo-message" class="small text-muted"></p>
          </div>
        </div>

        <form action="/start_computrabajo_scraper" method="post">
          <div id="computrabajo-search-params">
            <div class="search-row mb-3 p-3 border rounded bg-light position-relative">
              <div class="mb-2">
                <label class="form-label">Puesto / Palabras Clave</label>
                <input type="text" class="form-control" name="position[]" placeholder="ej. Python Developer" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Ubicaci√≥n</label>
                <input type="text" class="form-control" name="location[]" placeholder="ej. Buenos Aires">
              </div>
              <button type="button"
                class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2 remove-search"
                title="Eliminar b√∫squeda">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>

          <div class="d-flex justify-content-between mb-3">
            <button type="button" class="btn btn-outline-danger btn-sm" id="add-computrabajo-search">
              <i class="bi bi-plus-circle"></i> Agregar B√∫squeda
            </button>
          </div>

          <button type="submit" class="btn btn-danger w-100">
            <i class="bi bi-search"></i> Iniciar Scraper de Computrabajo
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Bumeran Scraper -->
  <div class="col-md-6">
    <div class="card mb-4 shadow">
      <div class="card-header bg-success text-white">
        <h4 class="mb-0"><i class="bi bi-building"></i> Scraper de Bumeran</h4>
      </div>
      <div class="card-body">
        <div class="job-status-container mb-3">
          <div id="bumeran-status-box">
            <div class="d-flex justify-content-between mb-2">
              <span><strong>Estado:</strong> <span id="bumeran-status">Inactivo</span></span>
            </div>
            <div class="progress mb-2">
              <div id="bumeran-progress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
            </div>
            <p id="bumeran-message" class="small text-muted"></p>
          </div>
        </div>

        <form action="/start_bumeran_scraper" method="post">
          <div id="bumeran-search-params">
            <div class="search-row mb-3 p-3 border rounded bg-light position-relative">
              <div class="mb-2">
                <label class="form-label">Puesto / Palabras Clave</label>
                <input type="text" class="form-control" name="position[]" placeholder="ej. Data Analyst" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Ubicaci√≥n</label>
                <input type="text" class="form-control" name="location[]" placeholder="ej. C√≥rdoba">
              </div>
              <button type="button"
                class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2 remove-search"
                title="Eliminar b√∫squeda">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>

          <div class="d-flex justify-content-between mb-3">
            <button type="button" class="btn btn-outline-success btn-sm" id="add-bumeran-search">
              <i class="bi bi-plus-circle"></i> Agregar B√∫squeda
            </button>
          </div>

          <button type="submit" class="btn btn-success w-100">
            <i class="bi bi-search"></i> Iniciar Scraper de Bumeran
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Add search row buttons
    document.getElementById('add-indeed-search').addEventListener('click', function () {
      addSearchRow('indeed-search-params');
    });

    document.getElementById('add-linkedin-search').addEventListener('click', function () {
      addSearchRow('linkedin-search-params');
    });

    document.getElementById('add-computrabajo-search').addEventListener('click', function () {
      addSearchRow('computrabajo-search-params');
    });

    document.getElementById('add-bumeran-search').addEventListener('click', function () {
      addSearchRow('bumeran-search-params');
    });

    // Handle remove search buttons
    document.addEventListener('click', function (e) {
      if (e.target.closest('.remove-search')) {
        const row = e.target.closest('.search-row');
        if (row && row.parentElement.querySelectorAll('.search-row').length > 1) {
          row.remove();
        }
      }
    });

    // Start polling for status updates
    pollStatus();
  });

  function addSearchRow(containerId) {
    const container = document.getElementById(containerId);
    const newRow = container.querySelector('.search-row').cloneNode(true);

    // Clear inputs
    newRow.querySelectorAll('input').forEach(input => {
      input.value = '';
    });

    container.appendChild(newRow);
  }

  function toggleFilters(filterId) {
    const filterDiv = document.getElementById(filterId);
    const buttonId = 'toggle-' + filterId;
    const button = document.getElementById(buttonId);

    if (filterDiv.style.display === 'none') {
      filterDiv.style.display = 'block';
      if (button) button.textContent = 'Ocultar Filtros';
    } else {
      filterDiv.style.display = 'none';
      if (button) button.textContent = 'Filtros Avanzados';
    }
  }

  function pollStatus() {
    fetch('/status')
      .then(response => response.json())
      .then(data => {
        updateStatusUI('indeed', data.indeed_scraping);
        updateStatusUI('linkedin', data.linkedin_scraping);
        updateStatusUI('computrabajo', data.computrabajo_scraping);
        updateStatusUI('bumeran', data.bumeran_scraping);

        updateUniversalStatusUI(data.universal_scraping);


        // Poll again in 2 seconds
        setTimeout(pollStatus, 2000);
      })
      .catch(error => {
        console.error('Error polling status:', error);
        setTimeout(pollStatus, 5000);  // Try again after 5 seconds
      });
  }

  function updateStatusUI(prefix, jobData) {
    const statusElem = document.getElementById(`${prefix}-status`);
    const progressElem = document.getElementById(`${prefix}-progress`);
    const messageElem = document.getElementById(`${prefix}-message`);

    if (!statusElem || !jobData) return;

    // Update status text and color
    const statusTranslations = {
      'idle': 'Inactivo',
      'running': 'Ejecutando',
      'completed': 'Completado',
      'failed': 'Fall√≥'
    };
    const statusText = statusTranslations[jobData.status] || jobData.status;

    statusElem.textContent = statusText.charAt(0).toUpperCase() + statusText.slice(1);
    statusElem.className = '';

    if (jobData.status === 'running') {
      statusElem.classList.add('text-primary');
      progressElem.classList.add('progress-bar-striped', 'progress-bar-animated');
    } else if (jobData.status === 'completed') {
      statusElem.classList.add('text-success');
      progressElem.classList.remove('progress-bar-striped', 'progress-bar-animated');
    } else if (jobData.status === 'failed') {
      statusElem.classList.add('text-danger');
      progressElem.classList.remove('progress-bar-striped', 'progress-bar-animated');
    } else {
      // Idle
      statusElem.classList.add('text-muted');
      progressElem.classList.remove('progress-bar-striped', 'progress-bar-animated');
    }

    // Update progress bar
    progressElem.style.width = `${jobData.progress}%`;
    progressElem.setAttribute('aria-valuenow', jobData.progress);

    // Update message
    messageElem.textContent = jobData.message;
  }


  function updateUniversalStatusUI(jobData) {
    if (!jobData) return;

    const statusElem = document.getElementById('universal-status');
    const progressElem = document.getElementById('universal-progress');
    const messageElem = document.getElementById('universal-message');

    if (!statusElem) return;

    // Update status text and color
    const statusTranslations = {
      'idle': 'Inactivo',
      'running': 'Ejecutando',
      'completed': 'Completado',
      'failed': 'Fall√≥'
    };
    const statusText = statusTranslations[jobData.status] || jobData.status;

    statusElem.textContent = statusText.charAt(0).toUpperCase() + statusText.slice(1);
    statusElem.className = '';

    if (jobData.status === 'running') {
      statusElem.classList.add('text-primary');
      progressElem.classList.add('progress-bar-striped', 'progress-bar-animated');
    } else if (jobData.status === 'completed') {
      statusElem.classList.add('text-success');
      progressElem.classList.remove('progress-bar-striped', 'progress-bar-animated');
    } else if (jobData.status === 'failed') {
      statusElem.classList.add('text-danger');
      progressElem.classList.remove('progress-bar-striped', 'progress-bar-animated');
    } else {
      statusElem.classList.add('text-muted');
      progressElem.classList.remove('progress-bar-striped', 'progress-bar-animated');
    }

    // Update progress bar
    progressElem.style.width = `${jobData.progress}%`;
    progressElem.setAttribute('aria-valuenow', jobData.progress);
    progressElem.textContent = `${jobData.progress}%`;

    // Update message
    messageElem.textContent = jobData.message;

    // Update individual scraper statuses
    if (jobData.scrapers) {
      for (const [name, scraperData] of Object.entries(jobData.scrapers)) {
        const badgeElem = document.getElementById(`universal-${name}-status`);
        if (badgeElem) {
          badgeElem.className = 'badge';
          if (scraperData.status === 'running') {
            badgeElem.classList.add('bg-primary');
            badgeElem.textContent = 'Ejecutando...';
          } else if (scraperData.status === 'completed') {
            badgeElem.classList.add('bg-success');
            badgeElem.textContent = '‚úì Completado';
          } else if (scraperData.status === 'failed') {
            badgeElem.classList.add('bg-danger');
            badgeElem.textContent = '‚úó Error';
          } else if (scraperData.status === 'skipped') {
            badgeElem.classList.add('bg-warning');
            badgeElem.textContent = 'Omitido';
          } else {
            badgeElem.classList.add('bg-secondary');
            badgeElem.textContent = 'Esperando';
          }
        }
      }
    }
  }

</script>
{% endblock %}