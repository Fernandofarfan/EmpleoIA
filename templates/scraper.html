<!-- job_scraper_app/templates/scraper.html -->
{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/scraper_premium.css') }}">
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="fw-bold text-dark mb-0">Buscar Empleos</h2>
  <span class="badge bg-light text-dark border">v1.2.0</span>
</div>

<!-- Resume Upload Notice -->
<div class="alert alert-custom mb-5">
  <div class="d-flex align-items-center">
    <div class="fs-1 text-primary me-3">
      <i class="bi bi-file-earmark-person"></i>
    </div>
    <div>
      <h5 class="alert-heading fw-bold mb-1">¡Optimizá tu búsqueda con IA!</h5>
      <p class="mb-0 text-muted">
        Cargá tu currículum en tu <a href="/profile" class="fw-bold text-primary text-decoration-none">Perfil</a> para
        habilitar la optimización automática.
        La IA analizará cada oferta y adaptará tu CV para aumentar tus chances.
      </p>
    </div>
  </div>
</div>

<!-- Universal Scraper - Search All Platforms -->
<div class="row mb-5">
  <div class="col-12">
    <div class="card card-universal shadow-lg">
      <div class="card-header border-0">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h3 class="mb-1"><i class="bi bi-rocket-takeoff-fill me-2"></i> Scraper Universal</h3>
            <p class="mb-0 opacity-75">Búsqueda simultánea en múltiples plataformas</p>
          </div>
          <span
            class="badge bg-white text-primary bg-opacity-25 border border-white border-opacity-25">Recomendado</span>
        </div>
      </div>
      <div class="card-body p-4">
        <div class="job-status-container mb-4">
          <div id="universal-status-box">
            <div class="d-flex justify-content-between mb-2">
              <span class="fw-medium">Estado: <span id="universal-status"
                  class="badge bg-secondary">Inactivo</span></span>
              <span id="universal-progress-text" class="fw-bold text-primary">0%</span>
            </div>
            <div class="progress mb-3" style="height: 12px;">
              <div id="universal-progress" class="progress-bar progress-bar-striped bg-primary" role="progressbar"
                style="width: 0%"></div>
            </div>
            <p id="universal-message" class="small text-muted mb-4 text-center fst-italic"></p>

            <!-- Individual scraper status -->
            <div class="row g-3" id="universal-scrapers-status">
              <div class="col-md-3 col-6">
                <div class="mini-card" id="card-universal-indeed">
                  <div class="d-flex flex-column align-items-center">
                    <small class="text-muted mb-1 fw-bold">Indeed</small>
                    <span id="universal-indeed-status" class="badge bg-light text-dark border">Esperando</span>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6">
                <div class="mini-card" id="card-universal-linkedin">
                  <div class="d-flex flex-column align-items-center">
                    <small class="text-muted mb-1 fw-bold">LinkedIn</small>
                    <span id="universal-linkedin-status" class="badge bg-light text-dark border">Esperando</span>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6">
                <div class="mini-card" id="card-universal-computrabajo">
                  <div class="d-flex flex-column align-items-center">
                    <small class="text-muted mb-1 fw-bold">Computrabajo</small>
                    <span id="universal-computrabajo-status" class="badge bg-light text-dark border">Esperando</span>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6">
                <div class="mini-card" id="card-universal-bumeran">
                  <div class="d-flex flex-column align-items-center">
                    <small class="text-muted mb-1 fw-bold">Bumeran</small>
                    <span id="universal-bumeran-status" class="badge bg-light text-dark border">Esperando</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <form action="/start_universal_scraper" method="post" class="mt-4">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Puesto / Palabras Clave</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0"><i class="bi bi-search text-muted"></i></span>
                <input type="text" class="form-control border-start-0 ps-0" name="position"
                  placeholder="ej. Python Developer" required>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Ubicación</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0"><i class="bi bi-geo-alt text-muted"></i></span>
                <input type="text" class="form-control border-start-0 ps-0" name="location"
                  placeholder="ej. Buenos Aires, Argentina">
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-universal w-100 mt-4 py-3 fs-5 shadow-sm">
            <i class="bi bi-stars me-2"></i> Iniciar Búsqueda Universal
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<h4 class="mb-4 fw-bold text-secondary border-bottom pb-2">Scrapers Individuales</h4>

<div class="row g-4">
  <!-- Indeed Scraper -->
  <div class="col-md-6">
    <div class="card card-indeed h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-briefcase me-2"></i> Indeed</span>
        <i class="bi bi-arrow-up-right-circle opacity-50"></i>
      </div>
      <div class="card-body">
        <div class="job-status-container mb-3">
          <div id="indeed-status-box">
            <div class="d-flex justify-content-between mb-2">
              <span class="small fw-bold text-muted">ESTADO</span>
              <span id="indeed-status" class="badge bg-light text-dark border">Inactivo</span>
            </div>
            <div class="progress mb-2" style="height: 6px;">
              <div id="indeed-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <p id="indeed-message" class="small text-muted text-truncate"></p>
          </div>
        </div>

        <form action="/start_indeed_scraper" method="post">
          <div id="indeed-search-params">
            <div class="search-row mb-3 p-3 bg-light rounded-3 position-relative border border-light">
              <div class="mb-2">
                <label class="form-label small">Puesto</label>
                <input type="text" class="form-control form-control-sm" name="position[]"
                  placeholder="ej. Python Developer" required>
              </div>
              <div class="mb-2">
                <label class="form-label small">Ubicación</label>
                <input type="text" class="form-control form-control-sm" name="location[]"
                  placeholder="ej. Buenos Aires">
              </div>

              <button type="button"
                class="btn btn-sm btn-link text-danger position-absolute top-0 end-0 m-1 remove-search text-decoration-none"
                title="Eliminar">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          </div>

          <div class="d-flex justify-content-between mb-3">
            <button type="button" class="btn btn-outline-primary btn-sm" id="add-indeed-search">
              <i class="bi bi-plus-lg me-1"></i> Agregar Fila
            </button>
          </div>

          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-search me-2"></i> Buscar en Indeed
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- LinkedIn Scraper -->
  <div class="col-md-6">
    <div class="card card-linkedin h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-linkedin me-2"></i> LinkedIn</span>
        <i class="bi bi-arrow-up-right-circle opacity-50"></i>
      </div>
      <div class="card-body">
        <div class="job-status-container mb-3">
          <div id="linkedin-status-box">
            <div class="d-flex justify-content-between mb-2">
              <span class="small fw-bold text-muted">ESTADO</span>
              <span id="linkedin-status" class="badge bg-light text-dark border">Inactivo</span>
            </div>
            <div class="progress mb-2" style="height: 6px;">
              <div id="linkedin-progress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
            </div>
            <p id="linkedin-message" class="small text-muted text-truncate"></p>
          </div>
        </div>

        <form action="/start_linkedin_scraper" method="post">
          <div id="linkedin-search-params">
            <div class="search-row mb-3 p-3 bg-light rounded-3 position-relative border border-light">
              <div class="mb-2">
                <label class="form-label small">Puesto</label>
                <input type="text" class="form-control form-control-sm" name="position[]"
                  placeholder="ej. Software Engineer" required>
              </div>
              <div class="mb-2">
                <label class="form-label small">Ubicación</label>
                <input type="text" class="form-control form-control-sm" name="location[]" placeholder="ej. Argentina">
              </div>
              <button type="button"
                class="btn btn-sm btn-link text-danger position-absolute top-0 end-0 m-1 remove-search text-decoration-none"
                title="Eliminar">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          </div>

          <div class="d-flex justify-content-between mb-3">
            <button type="button" class="btn btn-outline-info btn-sm" id="add-linkedin-search">
              <i class="bi bi-plus-lg me-1"></i> Agregar Fila
            </button>
          </div>

          <div class="mb-3">
            <button type="button" class="btn btn-outline-secondary btn-sm w-100"
              onclick="toggleFilters('linkedin-filters')" id="toggle-linkedin-filters">
              <i class="bi bi-sliders me-1"></i> Configuración Avanzada
            </button>
            <div id="linkedin-filters" class="mt-3 p-3 border rounded bg-light" style="display: none;">
              <div class="mb-0">
                <label class="form-label small">Token LinkedIn (li_at)</label>
                <input type="text" class="form-control form-control-sm" name="linkedin_token"
                  placeholder="Opcional si está en .env">
                <div class="form-text small">Cookie necesaria para autenticación.</div>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-info text-white w-100">
            <i class="bi bi-search me-2"></i> Buscar en LinkedIn
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Computrabajo Scraper -->
  <div class="col-md-6">
    <div class="card card-computrabajo h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-briefcase-fill me-2"></i> Computrabajo</span>
        <i class="bi bi-arrow-up-right-circle opacity-50"></i>
      </div>
      <div class="card-body">
        <div class="job-status-container mb-3">
          <div id="computrabajo-status-box">
            <div class="d-flex justify-content-between mb-2">
              <span class="small fw-bold text-muted">ESTADO</span>
              <span id="computrabajo-status" class="badge bg-light text-dark border">Inactivo</span>
            </div>
            <div class="progress mb-2" style="height: 6px;">
              <div id="computrabajo-progress" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
            </div>
            <p id="computrabajo-message" class="small text-muted text-truncate"></p>
          </div>
        </div>

        <form action="/start_computrabajo_scraper" method="post">
          <div id="computrabajo-search-params">
            <div class="search-row mb-3 p-3 bg-light rounded-3 position-relative border border-light">
              <div class="mb-2">
                <label class="form-label small">Puesto</label>
                <input type="text" class="form-control form-control-sm" name="position[]"
                  placeholder="ej. Python Developer" required>
              </div>
              <div class="mb-2">
                <label class="form-label small">Ubicación</label>
                <input type="text" class="form-control form-control-sm" name="location[]"
                  placeholder="ej. Buenos Aires">
              </div>
              <button type="button"
                class="btn btn-sm btn-link text-danger position-absolute top-0 end-0 m-1 remove-search text-decoration-none"
                title="Eliminar">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          </div>

          <div class="d-flex justify-content-between mb-3">
            <button type="button" class="btn btn-outline-danger btn-sm" id="add-computrabajo-search">
              <i class="bi bi-plus-lg me-1"></i> Agregar Fila
            </button>
          </div>

          <button type="submit" class="btn btn-danger w-100">
            <i class="bi bi-search me-2"></i> Buscar en Computrabajo
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Bumeran Scraper -->
  <div class="col-md-6">
    <div class="card card-bumeran h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-building me-2"></i> Bumeran</span>
        <i class="bi bi-arrow-up-right-circle opacity-50"></i>
      </div>
      <div class="card-body">
        <div class="job-status-container mb-3">
          <div id="bumeran-status-box">
            <div class="d-flex justify-content-between mb-2">
              <span class="small fw-bold text-muted">ESTADO</span>
              <span id="bumeran-status" class="badge bg-light text-dark border">Inactivo</span>
            </div>
            <div class="progress mb-2" style="height: 6px;">
              <div id="bumeran-progress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
            </div>
            <p id="bumeran-message" class="small text-muted text-truncate"></p>
          </div>
        </div>

        <form action="/start_bumeran_scraper" method="post">
          <div id="bumeran-search-params">
            <div class="search-row mb-3 p-3 bg-light rounded-3 position-relative border border-light">
              <div class="mb-2">
                <label class="form-label small">Puesto</label>
                <input type="text" class="form-control form-control-sm" name="position[]" placeholder="ej. Data Analyst"
                  required>
              </div>
              <div class="mb-2">
                <label class="form-label small">Ubicación</label>
                <input type="text" class="form-control form-control-sm" name="location[]" placeholder="ej. Córdoba">
              </div>
              <button type="button"
                class="btn btn-sm btn-link text-danger position-absolute top-0 end-0 m-1 remove-search text-decoration-none"
                title="Eliminar">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          </div>

          <div class="d-flex justify-content-between mb-3">
            <button type="button" class="btn btn-outline-success btn-sm" id="add-bumeran-search">
              <i class="bi bi-plus-lg me-1"></i> Agregar Fila
            </button>
          </div>

          <button type="submit" class="btn btn-success w-100">
            <i class="bi bi-search me-2"></i> Buscar en Bumeran
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Add search row buttons
    document.getElementById('add-indeed-search').addEventListener('click', function () {
      addSearchRow('indeed-search-params');
    });

    document.getElementById('add-linkedin-search').addEventListener('click', function () {
      addSearchRow('linkedin-search-params');
    });

    document.getElementById('add-computrabajo-search').addEventListener('click', function () {
      addSearchRow('computrabajo-search-params');
    });

    document.getElementById('add-bumeran-search').addEventListener('click', function () {
      addSearchRow('bumeran-search-params');
    });

    // Handle remove search buttons
    document.addEventListener('click', function (e) {
      if (e.target.closest('.remove-search')) {
        const row = e.target.closest('.search-row');
        if (row && row.parentElement.querySelectorAll('.search-row').length > 1) {
          row.remove();
        }
      }
    });

    // Start polling for status updates
    pollStatus();
  });

  function addSearchRow(containerId) {
    const container = document.getElementById(containerId);
    const newRow = container.querySelector('.search-row').cloneNode(true);

    // Clear inputs
    newRow.querySelectorAll('input').forEach(input => {
      input.value = '';
    });

    container.appendChild(newRow);
  }

  function toggleFilters(filterId) {
    const filterDiv = document.getElementById(filterId);
    const buttonId = 'toggle-' + filterId;
    const button = document.getElementById(buttonId);

    if (filterDiv.style.display === 'none') {
      filterDiv.style.display = 'block';
      if (button) button.textContent = 'Ocultar Configuración';
    } else {
      filterDiv.style.display = 'none';
      if (button) button.textContent = 'Configuración Avanzada';
    }
  }

  function pollStatus() {
    fetch('/status')
      .then(response => response.json())
      .then(data => {
        updateStatusUI('indeed', data.indeed_scraping);
        updateStatusUI('linkedin', data.linkedin_scraping);
        updateStatusUI('computrabajo', data.computrabajo_scraping);
        updateStatusUI('bumeran', data.bumeran_scraping);

        updateUniversalStatusUI(data.universal_scraping);

        // Poll again in 2 seconds
        setTimeout(pollStatus, 2000);
      })
      .catch(error => {
        console.error('Error polling status:', error);
        setTimeout(pollStatus, 5000);  // Try again after 5 seconds
      });
  }

  function updateStatusUI(prefix, jobData) {
    const statusElem = document.getElementById(`${prefix}-status`);
    const progressElem = document.getElementById(`${prefix}-progress`);
    const messageElem = document.getElementById(`${prefix}-message`);

    if (!statusElem || !jobData) return;

    // Update status text and color
    const statusTranslations = {
      'idle': 'Inactivo',
      'running': 'Ejecutando',
      'completed': 'Completado',
      'failed': 'Falló'
    };
    const statusText = statusTranslations[jobData.status] || jobData.status;

    statusElem.textContent = statusText.charAt(0).toUpperCase() + statusText.slice(1);

    // Reset classes
    statusElem.className = 'badge border';
    progressElem.className = 'progress-bar';
    if (prefix === 'linkedin') progressElem.classList.add('bg-info');
    else if (prefix === 'computrabajo') progressElem.classList.add('bg-danger');
    else if (prefix === 'bumeran') progressElem.classList.add('bg-success');

    if (jobData.status === 'running') {
      statusElem.classList.add('bg-primary', 'text-white', 'border-primary', 'animate-pulse');
      progressElem.classList.add('progress-bar-striped', 'progress-bar-animated');
    } else if (jobData.status === 'completed') {
      statusElem.classList.add('bg-success', 'text-white', 'border-success');
      progressElem.classList.remove('progress-bar-striped', 'progress-bar-animated');
    } else if (jobData.status === 'failed') {
      statusElem.classList.add('bg-danger', 'text-white', 'border-danger');
      progressElem.classList.remove('progress-bar-striped', 'progress-bar-animated');
    } else {
      // Idle
      statusElem.classList.add('bg-light', 'text-dark');
      progressElem.classList.remove('progress-bar-striped', 'progress-bar-animated');
    }

    // Update progress bar
    progressElem.style.width = `${jobData.progress}%`;
    progressElem.setAttribute('aria-valuenow', jobData.progress);

    // Update message
    messageElem.textContent = jobData.message;
  }

  function updateUniversalStatusUI(jobData) {
    if (!jobData) return;

    const statusElem = document.getElementById('universal-status');
    const progressElem = document.getElementById('universal-progress');
    const messageElem = document.getElementById('universal-message');
    const progressTextElem = document.getElementById('universal-progress-text');

    if (!statusElem) return;

    // Update status text and color
    const statusTranslations = {
      'idle': 'Inactivo',
      'running': 'Ejecutando',
      'completed': 'Completado',
      'failed': 'Falló'
    };
    const statusText = statusTranslations[jobData.status] || jobData.status;

    statusElem.textContent = statusText.charAt(0).toUpperCase() + statusText.slice(1);
    statusElem.className = 'badge';

    if (jobData.status === 'running') {
      statusElem.classList.add('bg-primary', 'animate-pulse');
      progressElem.classList.add('progress-bar-striped', 'progress-bar-animated');
    } else if (jobData.status === 'completed') {
      statusElem.classList.add('bg-success');
      progressElem.classList.remove('progress-bar-striped', 'progress-bar-animated');
    } else if (jobData.status === 'failed') {
      statusElem.classList.add('bg-danger');
      progressElem.classList.remove('progress-bar-striped', 'progress-bar-animated');
    } else {
      statusElem.classList.add('bg-secondary');
      progressElem.classList.remove('progress-bar-striped', 'progress-bar-animated');
    }

    // Update progress bar
    progressElem.style.width = `${jobData.progress}%`;
    progressElem.setAttribute('aria-valuenow', jobData.progress);
    if (progressTextElem) progressTextElem.textContent = `${jobData.progress}%`;

    // Update message
    messageElem.textContent = jobData.message;

    // Update individual scraper statuses
    if (jobData.scrapers) {
      for (const [name, scraperData] of Object.entries(jobData.scrapers)) {
        const badgeElem = document.getElementById(`universal-${name}-status`);
        const cardElem = document.getElementById(`card-universal-${name}`);

        if (badgeElem) {
          badgeElem.className = 'badge border';
          if (cardElem) cardElem.className = 'mini-card';

          if (scraperData.status === 'running') {
            badgeElem.classList.add('bg-primary', 'text-white', 'border-primary', 'animate-pulse');
            badgeElem.textContent = 'Ejecutando...';
            if (cardElem) cardElem.classList.add('active');
          } else if (scraperData.status === 'completed') {
            badgeElem.classList.add('bg-success', 'text-white', 'border-success');
            badgeElem.textContent = '✓ Completado';
            if (cardElem) cardElem.classList.add('completed');
          } else if (scraperData.status === 'failed') {
            badgeElem.classList.add('bg-danger', 'text-white', 'border-danger');
            badgeElem.textContent = '✗ Error';
          } else if (scraperData.status === 'skipped') {
            badgeElem.classList.add('bg-warning', 'text-dark', 'border-warning');
            badgeElem.textContent = 'Omitido';
          } else {
            badgeElem.classList.add('bg-light', 'text-dark');
            badgeElem.textContent = 'Esperando';
          }
        }
      }
    }
  }
</script>
{% endblock %}