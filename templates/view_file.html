{% extends "base.html" %} {% block content %}
<div class="container-fluid mt-3">
  <div class="row mb-3">
    <div class="col-12">
      <h3>Visualizando: {{ filename }}</h3>
      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> <strong>Total de Empleos:</strong> {{
        total_jobs }} | Haz clic en "Aplicado" después de postularte a cada trabajo
      </div>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-12 text-end">
      <button class="btn btn-success me-2" onclick="saveApplicationStatus()">
        <i class="bi bi-save"></i> Guardar y Enviar Postulaciones
      </button>
      <a href="/download_csv/{{ filename }}" class="btn btn-primary me-2">
        <i class="bi bi-download"></i> Descargar CSV Completo
      </a>
      <a href="{{ url_for('results') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Volver a Resultados
      </a>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="table-responsive">{{ table_html | safe }}</div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Postulaciones Guardadas</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="modalMessage"></p>
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="sendConnections" checked />
          <label class="form-check-label" for="sendConnections">
            Enviar solicitudes de conexión de LinkedIn a empresas aplicadas
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
        <button type="button" class="btn btn-primary" onclick="processConnections()">
          Continuar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let appliedJobs = {};

  document.addEventListener('DOMContentLoaded', function () {
    modifyTable();
  });

  function modifyTable() {
    const table = document.getElementById('jobTable');
    if (!table) return;

    const headerRow = table.querySelector('thead tr');
    const bodyRows = table.querySelectorAll('tbody tr');

    // Find column indices
    const headers = Array.from(headerRow.querySelectorAll('th'));
    let jobLinkIndex = -1;
    let applyUrlIndex = -1;

    headers.forEach((header, index) => {
      const text = header.textContent.trim();
      if (text.includes('Enlace') || text === 'URL') jobLinkIndex = index;
      if (text === 'Apply_URL') applyUrlIndex = index;
    });

    // Insert Track button header
    const trackHeader = document.createElement('th');
    trackHeader.innerHTML = 'Acciones';
    trackHeader.style.width = '180px'; // Wider for two buttons

    // Insert Applied header
    const appliedHeader = document.createElement('th');
    appliedHeader.innerHTML = 'Aplicado';
    appliedHeader.style.width = '80px';

    // Insert headers after Job_Link
    const insertIndex = jobLinkIndex !== -1 ? jobLinkIndex + 1 : headers.length;

    if (insertIndex < headers.length) {
      headerRow.insertBefore(trackHeader, headers[insertIndex]);
      headerRow.insertBefore(appliedHeader, headers[insertIndex + 1]);
    } else {
      headerRow.appendChild(trackHeader);
      headerRow.appendChild(appliedHeader);
    }

    // Hide Apply_URL column header if it exists (we'll use it for the button)
    if (applyUrlIndex !== -1) {
      headers[applyUrlIndex].style.display = 'none';
    }

    // Process each row
    bodyRows.forEach((row, index) => {
      const cells = row.querySelectorAll('td');

      // Get Apply URL if available
      let applyUrl = '#';
      if (applyUrlIndex !== -1 && cells[applyUrlIndex]) {
        applyUrl = cells[applyUrlIndex].textContent.trim();
        cells[applyUrlIndex].style.display = 'none'; // Hide the raw URL cell
      } else if (jobLinkIndex !== -1 && cells[jobLinkIndex]) {
        // Fallback to job link
        const link = cells[jobLinkIndex].querySelector('a');
        applyUrl = link ? link.href : '#';
      }

      // Create Actions cell (Super Button)
      const actionsCell = document.createElement('td');

      // Determine if we have a valid URL
      const hasUrl = applyUrl && applyUrl !== '#' && applyUrl !== 'N/A';

      actionsCell.innerHTML = `
              <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-primary fw-bold" 
                          onclick="applyAndTrack(${index}, '${hasUrl ? applyUrl : ''}', event)"
                          title="Postular, Seguir y Marcar como Aplicado"
                          ${!hasUrl ? 'disabled' : ''}>
                      <i class="bi bi-rocket-takeoff"></i> Postular y Seguir
                  </button>
              </div>
          `;

      // Create toggle cell
      const toggleCell = document.createElement('td');
      toggleCell.innerHTML = `
              <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="applied_${index}"
                         onchange="toggleApplied(${index}, this)">
              </div>
          `;

      // Insert cells
      if (insertIndex < cells.length) {
        row.insertBefore(actionsCell, cells[insertIndex]);
        row.insertBefore(toggleCell, cells[insertIndex + 1]);
      } else {
        row.appendChild(actionsCell);
        row.appendChild(toggleCell);
      }
    });
  }

  function applyAndTrack(index, url, event) {
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }

    if (!url) {
      alert('No hay enlace de postulación disponible para este trabajo.');
      return;
    }

    // 1. Open URL in new tab
    window.open(url, '_blank');

    // 2. Mark as Applied (visually and in data)
    const toggle = document.getElementById(`applied_${index}`);
    if (toggle && !toggle.checked) {
      toggle.checked = true;
      toggleApplied(index, toggle); // Updates appliedJobs and row style
    }

    // 3. Add to Tracker (as applied)
    addJobToTracker(index, event);
  }

  function toggleApplied(index, checkbox) {
    const row = checkbox.closest('tr');
    const cells = row.querySelectorAll('td');

    // Find column indices dynamically to be safe
    const table = document.getElementById('jobTable');
    const headerRow = table.querySelector('thead tr');
    const headers = Array.from(headerRow.querySelectorAll('th')).map(th => th.textContent.trim());

    const titleIdx = headers.indexOf('Título');
    const companyIdx = headers.indexOf('Empresa');
    const locationIdx = headers.indexOf('Ubicación');
    const jobLinkIdx = headers.indexOf('Enlace');

    if (checkbox.checked) {
      // Extract job data from row
      const jobData = {
        title: titleIdx !== -1 && cells[titleIdx] ? cells[titleIdx].textContent.trim() : 'Not specified',
        company: companyIdx !== -1 && cells[companyIdx] ? cells[companyIdx].textContent.trim() : 'Not specified',
        location: locationIdx !== -1 && cells[locationIdx] ? cells[locationIdx].textContent.trim() : 'Not specified',
        job_link: jobLinkIdx !== -1 && cells[jobLinkIdx] ? cells[jobLinkIdx].querySelector('a')?.href || '' : 'Not specified',
        job_type: 'Not specified',
        description: '',
        applied_date: new Date().toISOString()
      };

      appliedJobs[index] = jobData;
      row.classList.add('table-success');
    } else {
      delete appliedJobs[index];
      row.classList.remove('table-success');
    }
  }

  function saveApplicationStatus() {
    const appliedCount = Object.keys(appliedJobs).length;

    if (appliedCount === 0) {
      alert('Por favor marca al menos un trabajo como aplicado antes de guardar.');
      return;
    }

    fetch('/api/save_applications', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        filename: '{{ filename }}',
        applied_jobs: appliedJobs,
        total_jobs: {{ total_jobs }}
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('modalMessage').textContent =
          `Guardado exitosamente ${data.saved} postulación(es) para ${data.companies.length} empresas.`;
        new bootstrap.Modal(document.getElementById('successModal')).show();
      }
    })
    .catch(error => {
      console.error('Error saving applications:', error);
      alert('Error guardando postulaciones. Por favor intenta de nuevo.');
    });
  }

  function processConnections() {
    const sendConnections = document.getElementById('sendConnections').checked;

    if (sendConnections) {
      window.location.href = '/connections?auto_start=true';
    } else {
      window.location.href = '/results';
    }
  }

  // Add job to tracker
  function addJobToTracker(rowIndex, evt) {
    // Prevent any default button behavior
    if (evt) {
      evt.preventDefault();
      evt.stopPropagation();
    }

    const table = document.getElementById('jobTable');
    const headerRow = table.querySelector('thead tr');
    const headers = Array.from(headerRow.querySelectorAll('th')).map(th => th.textContent.trim());

    const row = table.querySelectorAll('tbody tr')[rowIndex];
    const cells = row.querySelectorAll('td');

    // Get the button element first
    // Note: When called from applyAndTrack, evt.target might be the icon or the button
    const button = evt ? evt.target.closest('button') : null;

    // Check if button is already disabled (already added)
    if (button && button.disabled) {
      console.log('Job already added to tracker');
      return;
    }

    // Find column indices dynamically
    const titleIdx = headers.indexOf('Título');
    const companyIdx = headers.indexOf('Empresa');
    const locationIdx = headers.indexOf('Ubicación');
    const jobLinkIdx = headers.indexOf('Enlace');
    const appliedIdx = headers.indexOf('Aplicado');

    console.log('Column indices:', { titleIdx, companyIdx, locationIdx, jobLinkIdx, appliedIdx });

    // Check if "Applied" toggle is checked for this row
    const appliedToggle = appliedIdx !== -1 && cells[appliedIdx] ?
      cells[appliedIdx].querySelector('input[type="checkbox"]') : null;
    const isApplied = appliedToggle ? appliedToggle.checked : false;

    // Determine status: "applied" if toggle is checked, otherwise "bookmarked"
    const status = isApplied ? 'applied' : 'bookmarked';

    // Extract job data from row cells
    const jobData = {
      title: titleIdx !== -1 && cells[titleIdx] ? cells[titleIdx].textContent.trim() : 'Not specified',
      company: companyIdx !== -1 && cells[companyIdx] ? cells[companyIdx].textContent.trim() : 'Not specified',
      location: locationIdx !== -1 && cells[locationIdx] ? cells[locationIdx].textContent.trim() : 'Not specified',
      job_link: jobLinkIdx !== -1 && cells[jobLinkIdx] ? cells[jobLinkIdx].querySelector('a')?.href || '' : '',
      status: status,
      excitement: 3,  // Default excitement level
      date_applied: isApplied ? new Date().toISOString().split('T')[0] : null  // Set date if applied
    };

    console.log('Sending job data:', jobData, 'Applied status:', isApplied);

    // Disable button immediately to prevent double-clicks
    if (button) {
      button.disabled = true;
      button.innerHTML = '<i class="bi bi-hourglass-split"></i> Añadiendo...';
    }

    // Send to API
    fetch('/api/tracker/job', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(jobData)
    })
      .then(response => {
        console.log('Response status:', response.status);
        // Handle 409 Conflict (duplicate) separately
        if (response.status === 409) {
          return response.json().then(data => {
            throw { isDuplicate: true, data: data };
          });
        }
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.success) {
          // Show success message
          if (button) {
            button.innerHTML = '<i class="bi bi-check-circle-fill"></i> Seguido!';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-success');
            button.disabled = true;
          }

          // Show success notification with status
          const statusMsg = jobData.status === 'applied' ? 'APLICADO' : 'GUARDADO';
          // alert(`Ô£à Trabajo añadido a la columna ${statusMsg} en el rastreador!`);
          // Removed alert to avoid popup spam when using Super Button
          console.log(`Trabajo añadido a la columna ${statusMsg} en el rastreador!`);
        } else {
          // Re-enable button on error
          if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-rocket-takeoff"></i> Postular y Seguir';
          }
          alert('ÔØî Error: ' + (data.error || 'Error desconocido'));
          console.error('API Error:', data);
        }
      })
      .catch(error => {
        // Handle duplicate error
        if (error.isDuplicate) {
          if (button) {
            button.innerHTML = '<i class="bi bi-check-circle"></i> Ya Seguido';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-secondary');
            button.disabled = true;
          }
          // alert('Ôä╣´©Å Este trabajo ya está en tu rastreador!');
          console.log('Este trabajo ya está en tu rastreador!');
          return;
        }

        // Handle other errors
        console.error('Full error details:', error);
        if (error.stack) {
          console.error('Error stack:', error.stack);
        }

        // Re-enable button on error
        if (button) {
          button.disabled = false;
          button.innerHTML = '<i class="bi bi-rocket-takeoff"></i> Postular y Seguir';
        }

        alert('ÔØî Error: ' + (error.message || 'Error desconocido'));
      });
  }
</script>


<link rel="stylesheet" href="{{ url_for('static', filename='css/view_file_premium.css') }}">

<style>
  .table-success {
    background-color: rgba(25, 135, 84, 0.1) !important;
  }

  .form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
  }

  .form-check-input {
    cursor: pointer;
  }

  #jobTable {
    font-size: 0.9rem;
  }

  .form-check {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 1.5rem;
  }
</style>
{% endblock %}